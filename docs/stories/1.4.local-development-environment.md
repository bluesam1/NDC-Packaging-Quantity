# Story 1.4: Local Development Environment

## Status

**Current Status**: Ready for Review

---

## Story

**As a** developer,  
**I want** a fully functional local development environment with emulators and mock APIs,  
**so that** I can develop and test the application without deploying to Firebase.

---

## Acceptance Criteria

1. Firebase emulators configured for Hosting and Functions
2. Local development scripts configured in `package.json`
3. Mock API server created for RxNorm and FDA APIs
4. Mock server returns realistic responses matching real API formats
5. Local development workflow documented
6. Developers can run frontend and backend locally
7. Frontend can connect to local Cloud Function emulator
8. Mock APIs can be started/stopped independently
9. All emulators start with a single command
10. Development environment matches production behavior

---

## Tasks / Subtasks

- [x] Configure Firebase emulators (AC: 1, 9)
  - [x] Install Firebase emulator suite
  - [x] Create `firebase.json` emulator configuration
  - [x] Configure Hosting emulator
  - [x] Configure Functions emulator
  - [x] Set up emulator ports (default or custom)
  - [x] Create script to start all emulators
- [x] Set up local development scripts (AC: 2, 6)
  - [x] Add `dev` script to root `package.json` (starts SvelteKit dev server)
  - [x] Add `dev:functions` script (starts Functions emulator)
  - [x] Add `dev:all` script (starts frontend + emulators + mock APIs)
  - [x] Add `emulators:start` script (starts Firebase emulators)
  - [x] Configure scripts to run in parallel where needed
- [x] Create mock API server (AC: 3, 4)
  - [x] Create `mock-api/` directory
  - [x] Set up Express server for mock APIs
  - [x] Create RxNorm mock endpoints:
    - [x] `GET /findRxcuiByString` - returns mock RxCUI
    - [x] `GET /rxcui/{rxcui}/ndcs` - returns mock NDC list
    - [x] `GET /approximateTerm` - returns mock approximate match
  - [x] Create FDA mock endpoints:
    - [x] `GET /drug/ndc.json?search=product_ndc:{ndc}` - returns mock NDC data
    - [x] `GET /drug/ndc.json?search=brand_name:{name}` - returns mock brand search
  - [x] Mock responses match real API response formats
  - [x] Add configurable delays to simulate network latency
- [x] Configure frontend to use local endpoints (AC: 7)
  - [x] Set up environment variables for API URLs
  - [x] Create `.env.local` for local development
  - [x] Configure frontend to use emulator URLs in dev mode
  - [x] Ensure CORS works with local setup
- [x] Document local development workflow (AC: 5, 10)
  - [x] Create/update `README.md` with setup instructions
  - [x] Document prerequisites (Node.js, Firebase CLI, etc.)
  - [x] Document how to start development environment
  - [x] Document how to use mock APIs
  - [x] Document how to test locally
  - [x] Include troubleshooting section

---

## Dev Notes

### Relevant Architecture Information

**Local Development** (from `docs/architecture.md` §11.7):
- Use Firebase emulators for Hosting + Functions
- Mock APIs: Simple Express server for RxNorm/FDA during development
- Testing: Unit tests (core algorithms), integration tests (API endpoint with emulators)

**Firebase Emulators** (from `docs/prd.md` §20):
- Use `firebase emulators:start` for Hosting + Functions
- Point UI to `/api/v1/compute` via Hosting rewrite
- Or use direct emulator URL: `http://localhost:5001/<project>/us-central1/compute`

**Mock API Requirements**:

**RxNorm API Mock** (from `docs/architecture.md` §6.1):
- Base URL: `https://rxnav.nlm.nih.gov/REST/`
- Endpoints to mock:
  - `GET /findRxcuiByString?name={drug_name}` - Returns: `{ "idGroup": { "rxnormId": ["12345"] } }`
  - `GET /rxcui/{rxcui}/ndcs` - Returns: `{ "ndcGroup": { "ndc": ["00000-1111-22", "00000-3333-44"] } }`
  - `GET /approximateTerm?term={drug_name}` - Returns: `{ "approximateGroup": { "candidate": [...] } }`

**FDA API Mock** (from `docs/architecture.md` §6.2):
- Base URL: `https://api.fda.gov/drug/ndc.json`
- Endpoints to mock:
  - `GET /?search=product_ndc:{ndc}` - Returns: `{ "results": [{ "product_ndc": "...", "package_ndc": "...", "package_description": "...", "marketing_status": "..." }] }`
  - `GET /?search=brand_name:{name}` - Returns: `{ "results": [...] }`

**Mock Response Examples**:
- Should return realistic data structures
- Should include common test cases (active NDCs, inactive NDCs, etc.)
- Should be configurable for different scenarios

### Source Tree Details

**File Locations**:
- Mock API server: `mock-api/server.ts` or `mock-api/index.js`
- Mock API data: `mock-api/data/` (JSON fixtures)
- Emulator config: `firebase.json` (emulators section)
- Environment config: `.env.local` (frontend), `.env` (functions)

**Directory Structure**:
```
ndc-qty/
├── mock-api/
│   ├── server.ts          # Express mock server
│   ├── data/
│   │   ├── rxnorm.json    # Mock RxNorm responses
│   │   └── fda.json       # Mock FDA responses
│   └── package.json       # Mock API dependencies
├── .env.local             # Frontend local env vars
├── .env.example           # Environment template
└── firebase.json          # Emulator config
```

### Development Scripts

**Recommended Scripts** (root `package.json`):
```json
{
  "scripts": {
    "dev": "vite dev",
    "dev:functions": "firebase emulators:start --only functions",
    "dev:mock-api": "node mock-api/server.js",
    "dev:all": "concurrently \"npm run dev\" \"npm run dev:functions\" \"npm run dev:mock-api\"",
    "emulators:start": "firebase emulators:start",
    "build": "vite build",
    "preview": "vite preview"
  }
}
```

**Note**: May need `concurrently` package for running multiple processes

### Environment Variables

**Frontend** (`.env.local`):
```
VITE_API_URL=http://localhost:5001/<project-id>/us-central1
VITE_MOCK_RXNORM_URL=http://localhost:3001
VITE_MOCK_FDA_URL=http://localhost:3001
```

**Functions** (`.env` or emulator config):
- Secrets will be mocked in emulator
- Can use `.env` file for local development

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- Integration tests: Use Firebase emulators
- Test infrastructure:
  - **Firebase Emulators**: Functions + Hosting emulators for local testing
  - **Mock APIs**: Express server for RxNorm/FDA during integration tests
- Test cases:
  - Emulators start successfully
  - Frontend connects to local function
  - Mock APIs return expected responses
  - End-to-end flow works locally

### Important Notes

- Mock APIs should be simple but realistic
- Consider using JSON fixtures for mock data
- Mock APIs should be easy to modify for different test scenarios
- Emulator configuration should match production as closely as possible
- Documentation should be clear and comprehensive
- Consider adding a `docker-compose.yml` if needed for complex setups (optional)

### Mock API Implementation Details

**Express Server Structure**:
- Simple Express server
- Routes matching real API endpoints
- JSON response fixtures
- Configurable response delays
- Error simulation capabilities (optional)

**Mock Data**:
- Use realistic test data
- Include common scenarios (active NDCs, inactive NDCs, etc.)
- Make it easy to add new test cases

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Owner |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Agent)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes List

1. **Firebase Emulators Configuration**: Verified `firebase.json` already has emulator configuration from Story 1.1:
   - Hosting emulator: Port 5000
   - Functions emulator: Port 5001
   - Emulator UI: Port 4000

2. **Development Scripts**: Added development scripts to root `package.json`:
   - `dev` - Already exists (SvelteKit dev server)
   - `dev:functions` - Starts Functions emulator only
   - `dev:mock-api` - Starts mock API server
   - `dev:all` - Starts all services concurrently (frontend + emulators + mock API)
   - `emulators:start` - Starts Firebase emulators (Hosting + Functions)
   - Installed `concurrently` package for running multiple processes in parallel

3. **Mock API Server**: Created Express-based mock API server in `mock-api/` directory:
   - **RxNorm Endpoints**:
     - `GET /findRxcuiByString?name={drug_name}` - Returns mock RxCUI
     - `GET /rxcui/{rxcui}/ndcs` - Returns mock NDC list
     - `GET /approximateTerm?term={drug_name}` - Returns mock approximate match
   - **FDA Endpoints**:
     - `GET /drug/ndc.json?search=product_ndc:{ndc}` - Returns mock NDC data
     - `GET /drug/ndc.json?search=brand_name:{name}` - Returns mock brand search
   - Mock responses match real API response formats
   - Configurable delay via `DELAY_MS` environment variable (default: 100ms)
   - Mock data fixtures in `mock-api/data/` directory

4. **Environment Variables**: Created environment variable configuration for switching between real and mock APIs:
   - **Frontend**: `.env.local` template (blocked by globalIgnore, documented in README)
     - `VITE_API_URL` - Firebase Functions emulator URL
   - **Functions**: `functions/.env` configuration
     - `USE_MOCK_APIS` - Boolean flag to switch between real and mock APIs (default: false)
     - `MOCK_RXNORM_URL` - Mock RxNorm API URL (default: http://localhost:3001)
     - `MOCK_FDA_URL` - Mock FDA API URL (default: http://localhost:3001)
     - `RXNORM_API_URL` - Real RxNorm API URL (default: https://rxnav.nlm.nih.gov/REST)
     - `FDA_API_URL` - Real FDA API URL (default: https://api.fda.gov/drug/ndc.json)
   - **Default Behavior**: Functions use real APIs unless `USE_MOCK_APIS=true` is set
   - **Production**: Always use real APIs (do not set `USE_MOCK_APIS=true` in production)

5. **Frontend Configuration**: Frontend can use environment variables via Vite's `import.meta.env`:
   - Environment variables prefixed with `VITE_` are exposed to frontend
   - CORS is already configured in functions to allow localhost in development

6. **Documentation**: Created comprehensive `README.md` with:
   - Prerequisites and setup instructions
   - Project structure overview
   - Local development setup guide
   - Available scripts documentation
   - Mock API server documentation
   - Firebase emulators usage guide
   - Testing instructions
   - Deployment guide
   - Troubleshooting section

7. **Mock API Dependencies**: Created `mock-api/package.json` with Express dependency and installed all dependencies.

### File List

**Created Files:**
- `mock-api/server.js` - Express mock API server
- `mock-api/package.json` - Mock API dependencies
- `mock-api/data/rxnorm.json` - Mock RxNorm data fixtures
- `mock-api/data/fda.json` - Mock FDA data fixtures
- `functions/.env.example` - Environment variable template for functions
- `README.md` - Comprehensive project documentation

**Modified Files:**
- `package.json` - Added development scripts (`dev:functions`, `dev:mock-api`, `dev:all`, `emulators:start`)
- `firebase.json` - Already configured with emulator settings from Story 1.1

**Dependencies Added:**
- `concurrently` - Run multiple processes in parallel (dev dependency)
- `express` - Express server for mock API (in mock-api/package.json)

---

## QA Results

_To be populated by QA agent_

