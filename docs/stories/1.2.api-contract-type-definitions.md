# Story 1.2: API Contract & Type Definitions

## Status

**Current Status**: Ready for Review

---

## Story

**As a** developer,  
**I want** well-defined TypeScript types and validation schemas for the API contract,  
**so that** I can ensure type safety and consistent data validation across the application.

---

## Acceptance Criteria

1. TypeScript types defined for `ComputeRequest`, `ComputeResponse`, and `ErrorResponse`
2. Types match the architecture document data model specifications exactly
3. Zod validation schemas created for runtime validation
4. Error codes defined as TypeScript union types
5. API contract documented (can reference architecture document)
6. Types are exported and can be imported by both frontend and backend
7. Validation schemas can validate request payloads at runtime
8. All types include JSDoc comments for documentation

---

## Tasks / Subtasks

- [x] Define TypeScript types (AC: 1, 2)
  - [x] Create `functions/src/types/index.ts`
  - [x] Define `ComputeRequest` type per architecture §4.1
  - [x] Define `ComputeResponse` type per architecture §4.2
  - [x] Define `ErrorResponse` type per architecture §4.3
  - [x] Add JSDoc comments to all types (AC: 8)
  - [x] Verify types match architecture document exactly
- [x] Create Zod validation schemas (AC: 3, 7)
  - [x] Install `zod` dependency in functions package
  - [x] Create `functions/src/validation/schemas.ts`
  - [x] Create `ComputeRequestSchema` using Zod
  - [x] Create validation for all required fields
  - [x] Create validation for optional fields
  - [x] Add custom validators for NDC format, days_supply range, etc.
  - [x] Export validation functions
- [x] Define error codes (AC: 4)
  - [x] Create error code union type: `'validation_error' | 'parse_error' | 'dependency_failure' | 'internal_error' | 'rate_limit_exceeded'`
  - [x] Add error code constants if needed
  - [x] Document error code meanings
- [x] Set up type exports (AC: 6)
  - [x] Ensure types can be imported from `functions/src/types`
  - [x] Consider future sharing with frontend (can be addressed later)
  - [x] Verify TypeScript compilation works with types
- [x] Document API contract (AC: 5)
  - [x] Reference architecture document §8 (API Specification)
  - [x] Add inline documentation in type files
  - [x] Ensure types are self-documenting with JSDoc

---

## Dev Notes

### Relevant Architecture Information

**Data Models** (from `docs/architecture.md` §4):

**ComputeRequest**:
```typescript
export type ComputeRequest = {
  drug_input: string;           // Required, 2-200 chars, drug name or NDC
  sig: string;                  // Required, 3-500 chars, prescription directions
  days_supply: number;          // Required, 1-365, integer
  preferred_ndcs?: string[];    // Optional, max 10 NDCs, valid NDC format
  quantity_unit_override?: 'tab'|'cap'|'mL'|'actuation'|'unit';  // Optional
};
```

**ComputeResponse**:
```typescript
export type ComputeResponse = {
  rxnorm: { rxcui: string; name: string };
  computed: { dose_unit: string; per_day: number; total_qty: number; days_supply: number };
  ndc_selection: {
    chosen?: { ndc: string; pkg_size: number; active: boolean; overfill: number; packs: number };
    alternates: Array<{ ndc: string; pkg_size: number; active: boolean; overfill: number; packs: number }>;
  };
  flags: { inactive_ndcs: string[]; mismatch: boolean; notes?: string[]; error_code?: string | null };
};
```

**ErrorResponse**:
```typescript
export type ErrorResponse = {
  error: string;
  error_code: 'validation_error' | 'parse_error' | 'dependency_failure' | 'internal_error' | 'rate_limit_exceeded';
  detail?: string;
  retry_after_ms?: number;
  field_errors?: Array<{ field: string; message: string }>;
};
```

**Validation Rules** (from `docs/prd.md` §12):
- `drug_input`: Required, 2-200 chars, accepts drug names or NDC format (11 digits with optional hyphens)
- `sig`: Required, 3-500 chars, free text
- `days_supply`: Required, integer, 1-365
- `preferred_ndcs`: Optional, array of strings, each must be valid NDC format (11 digits), max 10 NDCs
- `quantity_unit_override`: Optional, must be one of: `'tab'`, `'cap'`, `'mL'`, `'actuation'`, `'unit'`

**NDC Format Validation**:
- Accepts format: `00000-1111-22` or `00000111122` (11 digits total)
- Must validate NDC format in Zod schema

**Error Codes** (from `docs/architecture.md` §8):
- `validation_error`: Invalid input (400)
- `parse_error`: Unparseable SIG (422)
- `dependency_failure`: External API failure (424)
- `internal_error`: Internal server error (500)
- `rate_limit_exceeded`: Rate limit exceeded (429)

### Source Tree Details

**File Locations**:
- Types: `functions/src/types/index.ts`
- Validation schemas: `functions/src/validation/schemas.ts`

**Dependencies**:
- `zod`: Latest version (install in `functions/package.json`)

### Validation Requirements

**Zod Schema Requirements**:
1. Validate `drug_input`:
   - Required
   - String, min 2 chars, max 200 chars
   - Accepts drug name (any string) OR NDC format (11 digits with optional hyphens)
   - Custom validator for NDC format if provided
2. Validate `sig`:
   - Required
   - String, min 3 chars, max 500 chars
3. Validate `days_supply`:
   - Required
   - Integer, min 1, max 365
4. Validate `preferred_ndcs` (optional):
   - Array of strings
   - Each string must be valid NDC format (11 digits)
   - Max 10 NDCs
5. Validate `quantity_unit_override` (optional):
   - Must be one of: `'tab'`, `'cap'`, `'mL'`, `'actuation'`, `'unit'`

**Error Response Format**:
- Must include `error_code` from union type
- Must include `error` message (human-readable)
- Optional `detail` for additional context
- Optional `retry_after_ms` for 424 errors
- Optional `field_errors` array for validation errors

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- Test framework: TBD (Jest or Vitest recommended)
- Test file: `functions/src/types/index.test.ts` and `functions/src/validation/schemas.test.ts`
- Test coverage: All validation schemas should have tests
- Test cases:
  - Valid requests pass validation
  - Invalid requests fail with appropriate error messages
  - Edge cases (boundary values, empty strings, etc.)
  - NDC format validation (both formats)
  - Optional field validation

### Important Notes

- Types must exactly match architecture document specifications
- Zod schemas should provide clear, actionable error messages
- Consider creating helper functions for NDC format validation
- Types should be well-documented with JSDoc for IDE support
- Validation should happen at API boundary (will be used in Story 1.3)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Owner |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Agent)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes List

1. **TypeScript Types**: Created `functions/src/types/index.ts` with all required types (`ComputeRequest`, `ComputeResponse`, `ErrorResponse`, `ErrorCode`). All types include comprehensive JSDoc comments and match the architecture document §4 specifications exactly.

2. **Zod Validation Schemas**: Created `functions/src/validation/schemas.ts` with `computeRequestSchema` that validates:
   - `drug_input`: Required, 2-200 chars (accepts drug names or NDC format)
   - `sig`: Required, 3-500 chars
   - `days_supply`: Required, integer, 1-365
   - `preferred_ndcs`: Optional, array of valid NDC format strings, max 10 NDCs
   - `quantity_unit_override`: Optional, enum of valid unit types

3. **NDC Format Validation**: Implemented custom NDC format validator using regex pattern that accepts both formats: `00000-1111-22` or `00000111122` (11 digits total).

4. **Validation Functions**: Created `validateComputeRequest()` and `validateComputeRequestSafe()` functions for runtime validation. The safe version returns detailed field errors for better error handling.

5. **Error Codes**: Defined `ErrorCode` union type with all required error codes and documented their meanings.

6. **Type Exports**: Types and validation schemas are exported from `functions/src/index.ts` for easy importing in other stories.

7. **TypeScript Compilation**: Verified that all types compile successfully with TypeScript strict mode enabled.

### File List

**Created Files:**
- `functions/src/types/index.ts` - TypeScript type definitions (ComputeRequest, ComputeResponse, ErrorResponse, ErrorCode)
- `functions/src/validation/schemas.ts` - Zod validation schemas and validation functions

**Modified Files:**
- `functions/src/index.ts` - Added exports for types and validation schemas
- `functions/package.json` - Added `zod` dependency

**Dependencies Added:**
- `zod` - Runtime type validation library

---

## QA Results

_To be populated by QA agent_

