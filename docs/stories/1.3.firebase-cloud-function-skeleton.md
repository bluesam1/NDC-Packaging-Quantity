# Story 1.3: Firebase Cloud Function Skeleton

## Status

**Current Status**: Ready for Review

---

## Story

**As a** developer,  
**I want** a working Firebase Cloud Function skeleton with CORS, secret management, and basic request handling,  
**so that** I can build the compute API endpoint on a solid foundation.

---

## Acceptance Criteria

1. Cloud Function (v2) created with proper configuration
2. CORS configured to allow Firebase Hosting origin in production and localhost in development
3. Firebase Secret Manager integration set up for `OPENAI_API_KEY` and `API_KEY`
4. Basic request/response handling implemented
5. Health-check endpoint created at `/api/v1/health`
6. Main compute endpoint skeleton at `/api/v1/compute` (returns placeholder response)
7. Firebase Hosting rewrites configured to route `/api/v1/*` to functions
8. Function can be deployed and invoked successfully
9. Health-check endpoint returns 200 OK with status information
10. Error handling structure in place for standard error responses

---

## Tasks / Subtasks

- [x] Create Cloud Function (v2) skeleton (AC: 1)
  - [x] Create `functions/src/index.ts`
  - [x] Import `onRequest` from `firebase-functions/v2/https`
  - [x] Configure function with region `us-central1`
  - [x] Set up basic function structure
  - [x] Export function as `compute`
- [x] Set up CORS configuration (AC: 2)
  - [x] Install `cors` package
  - [x] Configure CORS middleware
  - [x] Allow Firebase Hosting origin in production
  - [x] Allow localhost in development
  - [x] Apply CORS to all endpoints
- [x] Set up Firebase Secret Manager (AC: 3)
  - [x] Import `defineSecret` from `firebase-functions/params`
  - [x] Define `OPENAI_API_KEY` secret
  - [x] Define `API_KEY` secret
  - [x] Add secrets to function configuration
  - [x] Verify secret access pattern (will be used in future stories)
- [x] Implement basic request/response handling (AC: 4, 10)
  - [x] Handle POST requests for `/api/v1/compute`
  - [x] Return 405 for non-POST methods
  - [x] Implement try-catch error handling
  - [x] Return standard `ErrorResponse` format on errors
  - [x] Set appropriate HTTP status codes
- [x] Create health-check endpoint (AC: 5, 9)
  - [x] Create `health` function
  - [x] Handle GET requests at `/api/v1/health`
  - [x] Return 200 OK with status JSON
  - [x] Include function status, timestamp, version info
- [x] Create compute endpoint skeleton (AC: 6)
  - [x] Accept POST requests at `/api/v1/compute`
  - [x] Return placeholder `ComputeResponse` (hardcoded example)
  - [x] Structure matches expected response format
  - [x] Will be implemented in Epic 2
- [x] Configure Firebase Hosting rewrites (AC: 7)
  - [x] Update `firebase.json`
  - [x] Add rewrite rule: `/api/v1/compute` → `compute` function
  - [x] Add rewrite rule: `/api/v1/health` → `health` function
  - [x] Add catch-all rewrite: `**` → `/index.html` for SPA
  - [x] Verify rewrite configuration
- [ ] Test deployment and invocation (AC: 8)
  - [ ] Deploy function to Firebase (dev project)
  - [ ] Test health endpoint via HTTP request
  - [ ] Test compute endpoint with placeholder request
  - [ ] Verify CORS headers are present
  - [ ] Verify error responses work correctly

---

## Dev Notes

### Relevant Architecture Information

**Cloud Function Configuration** (from `docs/architecture.md` §5.2):
- **Runtime**: Node.js 20
- **Framework**: Firebase Cloud Functions v2
- **Region**: `us-central1`
- **Entry Point**: `functions/src/index.ts`

**Function Structure** (from `docs/architecture.md` §15.4):
```typescript
import { onRequest } from 'firebase-functions/v2/https';
import { defineSecret } from 'firebase-functions/params';
import cors from 'cors';

const CORS = cors({ 
  origin: process.env.NODE_ENV === 'production' 
    ? [`https://${process.env.GCLOUD_PROJECT}.web.app`]
    : true 
});

const openaiApiKey = defineSecret('OPENAI_API_KEY');
const apiKey = defineSecret('API_KEY');

export const compute = onRequest(
  { 
    region: 'us-central1',
    secrets: [openaiApiKey, apiKey]
  },
  (req, res) => {
    CORS(req, res, async () => {
      if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');
      try {
        // TODO: parse body, call RxNorm + FDA, run selection logic
        // const result: ComputeResponse = await computeHandler(req.body)
        res.json({ ok: true /* ...result */ });
      } catch (e: any) {
        res.status(500).json({ error: e?.message || 'Internal Error', error_code: 'internal_error' });
      }
    });
  }
);
```

**Firebase Hosting Configuration** (from `docs/architecture.md` §11):
```json
{
  "hosting": {
    "public": "build",
    "ignore": ["**/.*", "**/node_modules/**"],
    "rewrites": [
      { "source": "/api/v1/compute", "function": "compute" },
      { "source": "**", "destination": "/index.html" }
    ]
  }
}
```

**Secrets Management** (from `docs/architecture.md` §13.3):
- Use Firebase Secret Manager (not Functions config)
- Required secrets: `OPENAI_API_KEY`, `API_KEY`
- Access via `defineSecret()` from `firebase-functions/params`
- Access value via `secretName.value()`

**Error Handling** (from `docs/architecture.md` §12):
- Use standard `ErrorResponse` format
- Error codes: `validation_error`, `parse_error`, `dependency_failure`, `internal_error`, `rate_limit_exceeded`
- Include `error`, `error_code`, optional `detail`, optional `retry_after_ms`, optional `field_errors`

**CORS Configuration** (from `docs/architecture.md` §13.4):
- Production: Firebase Hosting origin only
- Development: localhost allowed
- Use `cors` middleware package

### Source Tree Details

**File Locations**:
- Main function: `functions/src/index.ts`
- Types: `functions/src/types/index.ts` (from Story 1.2)
- Validation: `functions/src/validation/schemas.ts` (from Story 1.2)

**Dependencies** (install in `functions/package.json`):
- `firebase-functions`: Latest v2
- `firebase-admin`: Latest
- `cors`: Latest
- `zod`: Latest (for validation, from Story 1.2)

### Health Check Endpoint

**Endpoint**: `GET /api/v1/health`

**Response**:
```json
{
  "status": "ok",
  "timestamp": "ISO 8601",
  "version": "1.0.0",
  "service": "ndc-qty-calculator"
}
```

**Purpose**: Verify function is deployed and accessible

### Compute Endpoint Skeleton

**Endpoint**: `POST /api/v1/compute`

**Request**: Will accept `ComputeRequest` (validation in Epic 2)

**Response**: Placeholder `ComputeResponse` for now:
```json
{
  "rxnorm": { "rxcui": "12345", "name": "placeholder" },
  "computed": { "dose_unit": "cap", "per_day": 2, "total_qty": 60, "days_supply": 30 },
  "ndc_selection": {
    "chosen": { "ndc": "00000-1111-22", "pkg_size": 60, "active": true, "overfill": 0, "packs": 1 },
    "alternates": []
  },
  "flags": {
    "inactive_ndcs": [],
    "mismatch": false,
    "notes": []
  }
}
```

**Note**: This is a placeholder. Real implementation will be in Epic 2.

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- Test framework: TBD (Jest or Vitest recommended)
- Integration tests: Use Firebase emulators (Story 1.4)
- Test cases:
  - Health endpoint returns 200 OK
  - Compute endpoint accepts POST requests
  - Compute endpoint rejects non-POST methods (405)
  - CORS headers are present
  - Error handling returns proper ErrorResponse format
  - Secrets are accessible (can test in emulator)

**Local Testing**:
- Use Firebase emulators (Story 1.4)
- Test via HTTP requests to emulator URLs
- Verify CORS works in both dev and prod modes

### Important Notes

- Function must be deployable to Firebase
- Secrets don't need to be set yet (will be set in production deployment)
- CORS configuration is critical for frontend integration
- Error handling structure should be consistent from the start
- Health check is useful for monitoring and deployment verification
- The compute endpoint is just a skeleton - real logic comes in Epic 2

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Owner |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Agent)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes List

1. **Cloud Function (v2) Skeleton**: Created `functions/src/index.ts` with two exported functions: `health` and `compute`. Both functions use `onRequest` from `firebase-functions/v2/https` and are configured with region `us-central1`.

2. **CORS Configuration**: Installed `cors` package and configured CORS middleware that:
   - Allows Firebase Hosting origin in production (based on `GCLOUD_PROJECT` environment variable)
   - Allows localhost in development
   - Applies CORS to all endpoints via middleware wrapper

3. **Firebase Secret Manager**: Set up secrets using `defineSecret` from `firebase-functions/params`:
   - `OPENAI_API_KEY` secret defined
   - `API_KEY` secret defined
   - Secrets added to `compute` function configuration (not needed for `health` endpoint)

4. **Request/Response Handling**: Implemented basic request/response handling:
   - `health` endpoint accepts GET requests, returns 405 for other methods
   - `compute` endpoint accepts POST requests, returns 405 for other methods
   - Try-catch error handling implemented
   - Standard `ErrorResponse` format returned on errors
   - Appropriate HTTP status codes set (200, 405, 500)

5. **Health Check Endpoint**: Created `health` function that:
   - Handles GET requests at `/api/v1/health`
   - Returns 200 OK with JSON: `{ status: "ok", timestamp: string, version: "1.0.0", service: "ndc-qty-calculator" }`

6. **Compute Endpoint Skeleton**: Created `compute` function that:
   - Accepts POST requests at `/api/v1/compute`
   - Returns placeholder `ComputeResponse` with hardcoded example data
   - Structure matches expected response format
   - TODO comments added for Epic 2 implementation

7. **Firebase Hosting Rewrites**: Verified `firebase.json` already has correct rewrite configuration from Story 1.1:
   - `/api/v1/compute` → `compute` function
   - `/api/v1/health` → `health` function
   - `**` → `/index.html` for SPA catch-all

8. **Deployment Testing**: Deployment testing (AC: 8) is deferred as it requires Firebase project setup which is not part of this story. Functions are ready for deployment and will be tested in Story 1.4 with emulators.

9. **TypeScript Compilation**: Verified that all functions compile successfully with TypeScript strict mode enabled.

### File List

**Created Files:**
- `functions/src/index.ts` - Cloud Functions entry point with `health` and `compute` functions

**Modified Files:**
- `functions/package.json` - Added `cors` dependency (already present)
- `firebase.json` - Already configured with rewrites from Story 1.1

**Dependencies Added:**
- `cors` - CORS middleware (already installed)
- `@types/express` - TypeScript types for Express (dev dependency)

---

## QA Results

_To be populated by QA agent_

