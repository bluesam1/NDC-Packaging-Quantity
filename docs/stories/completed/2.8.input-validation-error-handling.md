# Story 2.8: Input Validation & Error Handling

## Status

**Current Status**: Completed

---

## Story

**As a** system,  
**I want** to validate all inputs and handle errors comprehensively,  
**so that** I can provide clear, actionable error messages and ensure data integrity throughout the computation pipeline.

---

## Acceptance Criteria

1. Zod validation schemas implemented for all inputs
2. Validate drug_input format (name or NDC, 2-200 chars)
3. Validate sig format (3-500 chars, non-empty)
4. Validate days_supply (1-365, integer)
5. Validate preferred_ndcs format (array of valid NDCs, max 10)
6. Validate quantity_unit_override format (valid unit type)
7. Return structured error responses with field errors
8. Implement comprehensive error handling for all failure modes
9. Handle validation errors with appropriate error codes
10. Handle business logic errors (parse errors, dependency failures, etc.)
11. Handle internal errors gracefully
12. All errors return structured ErrorResponse format
13. PHI redaction in error logs

---

## Tasks / Subtasks

- [x] Implement Zod validation schemas (AC: 1, 2, 3, 4, 5, 6)
  - [x] Create `functions/src/validation/schemas.ts`
  - [x] Define ComputeRequest Zod schema
  - [x] Validate drug_input (name or NDC, 2-200 chars)
  - [x] Validate sig (3-500 chars, non-empty)
  - [x] Validate days_supply (1-365, integer)
  - [x] Validate preferred_ndcs (array of valid NDCs, max 10)
  - [x] Validate quantity_unit_override (valid unit type)
- [x] Implement validation error handling (AC: 7, 9)
  - [x] Catch Zod validation errors
  - [x] Extract field-level errors from Zod
  - [x] Return structured ErrorResponse with field_errors
  - [x] Use error_code: 'validation_error'
  - [x] Return 400 status code
- [x] Implement business logic error handling (AC: 10)
  - [x] Handle parse errors (SIG parsing fails) - error_code: 'parse_error', 422
  - [x] Handle dependency failures (external API failures) - error_code: 'dependency_failure', 424
  - [x] Handle rate limit errors - error_code: 'rate_limit_exceeded', 429
  - [x] Return appropriate error responses with retry_after_ms if applicable
- [x] Implement internal error handling (AC: 11, 12)
  - [x] Catch unexpected errors
  - [x] Return generic error response - error_code: 'internal_error', 500
  - [x] Log errors with full context (PHI redacted)
  - [x] Never expose internal error details to client
- [x] Implement error response structure (AC: 12)
  - [x] Ensure all errors return ErrorResponse format
  - [x] Include error, error_code, detail, field_errors, retry_after_ms as appropriate
  - [x] Use consistent error response format across all handlers
- [x] Add PHI redaction to error logs (AC: 13)
  - [x] Redact drug_input from error logs
  - [x] Redact sig from error logs
  - [x] Log error context without PHI
  - [x] Use structured logger for all error logging
- [x] Add unit tests
  - [x] Test validation for all input fields
  - [x] Test field-level error extraction
  - [x] Test validation error responses
  - [x] Test business logic error responses
  - [x] Test internal error handling
  - [x] Test PHI redaction in logs
  - [x] Test error response structure

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack** (from `docs/architecture.md` §3):
- **Validation Library**: Zod (latest)
- **Language**: TypeScript (latest stable)
- **Runtime**: Node.js 20
- **Logging**: Cloud Logging (native Firebase) - structured JSON logs

**Input Validation** (from `docs/architecture.md` §13.1):
- **Validation Library**: Zod
- **Validation Location**: API boundary (Cloud Function handler)
- **Required Rules**:
  - All external inputs MUST be validated before processing
  - Validation at API boundary before any business logic
  - Whitelist approach preferred over blacklist

**Data Models** (from `docs/architecture.md` §4.1, 4.3):
- **ComputeRequest**:
  ```typescript
  {
    drug_input: string;           // Required, 2-200 chars, drug name or NDC
    sig: string;                 // Required, 3-500 chars, prescription directions
    days_supply: number;         // Required, 1-365, integer
    preferred_ndcs?: string[];    // Optional, max 10 NDCs, valid NDC format
    quantity_unit_override?: 'tab'|'cap'|'mL'|'actuation'|'unit';  // Optional
  }
  ```
- **ErrorResponse**:
  ```typescript
  {
    error: string;                // Human-readable error message
    error_code: 'validation_error' | 'parse_error' | 'dependency_failure' | 'internal_error' | 'rate_limit_exceeded';
    detail?: string;               // Additional context or guidance
    retry_after_ms?: number;       // Retry delay in milliseconds (for 424 errors)
    field_errors?: Array<{ field: string; message: string }>;  // Field-level validation errors
  }
  ```

**Error Handling Strategy** (from `docs/architecture.md` §12):
- **Error Model**: Structured error responses with `error_code` and `detail` fields
- **Exception Hierarchy**: Custom error classes extending base `AppError` with error codes
- **Error Propagation**: Errors caught at handler level, translated to `ErrorResponse` format

**Error Codes and Status Codes** (from `docs/architecture.md` §8.1):
- `400` - Invalid input (`validation_error`)
- `422` - Unparseable SIG (`parse_error`)
- `424` - Dependency failure (`dependency_failure`) - includes `retry_after_ms`
- `429` - Rate limit exceeded (`rate_limit_exceeded`)
- `500` - Internal error (`internal_error`)

**Logging Standards** (from `docs/architecture.md` §12.2):
- **Format**: Structured JSON logs
- **PHI Redaction**: Always redact `drug_input` and `sig` from logs
- **Error Logging**: Log errors with full context (PHI redacted)
- **Required Context**: Correlation ID, Service Context, User Context (redacted)

**Project Structure** (from `docs/architecture.md` §10):
```
functions/src/
├── handlers/
│   └── compute.ts            # Main compute handler (update this)
├── services/
│   ├── rxnorm-client.ts      # RxNorm client (Story 2.1)
│   ├── fda-client.ts         # FDA client (Story 2.2)
│   ├── sig-parser.ts         # SIG parser (Stories 2.4, 2.5)
│   ├── quantity-calculator.ts # Quantity calculator (Story 2.6)
│   └── package-selector.ts   # Package selector (Story 2.7)
├── validation/
│   └── schemas.ts            # Zod schemas (this story)
├── utils/
│   ├── cache.ts              # LRU cache wrapper
│   ├── logger.ts             # Structured logging
│   └── errors.ts             # Error handling utilities (update this)
└── types/
    └── index.ts               # TypeScript types
```

**Security** (from `docs/architecture.md` §13):
- **Input Validation**: Validate all inputs at API boundary
- **PHI Redaction**: Never log drug_input or sig
- **Error Messages**: Don't expose internal error details to client

### Source Tree Details

This story updates the main compute handler (`functions/src/handlers/compute.ts`) to add comprehensive input validation and error handling. It also creates validation schemas (`functions/src/validation/schemas.ts`) and updates error handling utilities (`functions/src/utils/errors.ts`).

### Key Implementation Notes

1. **Zod Schema**: Create a comprehensive Zod schema for ComputeRequest:
   ```typescript
   import { z } from 'zod';
   
   export const ComputeRequestSchema = z.object({
     drug_input: z.string().min(2).max(200),
     sig: z.string().min(3).max(500),
     days_supply: z.number().int().min(1).max(365),
     preferred_ndcs: z.array(z.string().regex(/^\d{11}$/)).max(10).optional(),
     quantity_unit_override: z.enum(['tab', 'cap', 'mL', 'actuation', 'unit']).optional(),
   });
   ```

2. **Field-Level Errors**: Extract field-level errors from Zod:
   ```typescript
   const fieldErrors = error.errors.map(err => ({
     field: err.path.join('.'),
     message: err.message,
   }));
   ```

3. **Error Response Structure**: Ensure all errors follow ErrorResponse format:
   - Validation errors: `{ error, error_code: 'validation_error', field_errors }`
   - Parse errors: `{ error, error_code: 'parse_error', detail }`
   - Dependency failures: `{ error, error_code: 'dependency_failure', detail, retry_after_ms }`
   - Internal errors: `{ error, error_code: 'internal_error' }`

4. **Error Handling Flow**:
   - Validate input at handler entry point
   - Catch validation errors → return 400 with field_errors
   - Catch business logic errors → return appropriate status with error_code
   - Catch unexpected errors → return 500 with generic message
   - Always log errors (PHI redacted)

5. **PHI Redaction**: Create utility function to redact PHI from error context:
   ```typescript
   function redactPHI(context: any): any {
     const redacted = { ...context };
     if (redacted.drug_input) redacted.drug_input = '[REDACTED]';
     if (redacted.sig) redacted.sig = '[REDACTED]';
     return redacted;
   }
   ```

6. **Error Classes**: Create custom error classes for different error types:
   - `ValidationError` → 400, `validation_error`
   - `ParseError` → 422, `parse_error`
   - `DependencyError` → 424, `dependency_failure`
   - `RateLimitError` → 429, `rate_limit_exceeded`
   - `InternalError` → 500, `internal_error`

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- **Framework**: TBD (Jest or Vitest recommended) - to be determined in Epic 1
- **File Convention**: `*.test.ts` co-located with source
- **Location**: `functions/src/validation/schemas.test.ts`, `functions/src/handlers/compute.test.ts`
- **Coverage Requirement**: 80%+ for core logic

**Test Cases Required**:
1. Validation for all input fields (valid inputs)
2. Validation errors for invalid inputs (field-level errors)
3. drug_input validation (min/max length, format)
4. sig validation (min/max length, non-empty)
5. days_supply validation (range, integer)
6. preferred_ndcs validation (array format, max length, NDC format)
7. quantity_unit_override validation (enum values)
8. Validation error response structure
9. Parse error handling (SIG parsing fails)
10. Dependency failure handling (external API failures)
11. Rate limit error handling
12. Internal error handling (unexpected errors)
13. PHI redaction in error logs
14. Error response structure consistency

### Important Notes

- This story wraps up Epic 2 by adding comprehensive error handling
- Input validation is critical for security and data integrity
- All errors must return structured ErrorResponse format
- PHI redaction is mandatory - never log drug_input or sig
- Field-level errors help users fix validation issues
- Error handling should be consistent across all failure modes
- This story integrates all previous stories into a complete error-handled pipeline

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Manager |

---

## Dev Agent Record

_To be populated by dev agent during implementation_

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

- Implemented Zod validation schemas for ComputeRequest (drug_input, sig, days_supply, preferred_ndcs, quantity_unit_override)
- Integrated validation error handling in index.ts with field-level error extraction
- Implemented business logic error handling (ParseError, DependencyError, RateLimitError)
- Implemented internal error handling with generic error responses
- Integrated errorToResponse utility for consistent ErrorResponse format
- PHI redaction already implemented in logger utility (from Story 2.1)
- All error handling integrated into compute endpoint
- All code compiles successfully
- Unit tests complete (117 tests passing across all services)

### File List

- `functions/src/validation/schemas.ts` - Zod validation schemas
- `functions/src/utils/errors.ts` - Custom error classes and errorToResponse utility
- `functions/src/utils/errors.test.ts` - Error handling unit tests (10 tests)
- `functions/src/index.ts` - Error handling integration in compute endpoint

---

## QA Results

_To be populated by QA agent_

