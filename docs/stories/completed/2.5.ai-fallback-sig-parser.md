# Story 2.5: AI Fallback SIG Parser

## Status

**Current Status**: Completed

---

## Story

**As a** system,  
**I want** to use AI (OpenAI GPT-4o-mini) as a fallback when rules-based SIG parsing fails,  
**so that** I can accurately parse complex or unusual prescription SIGs that don't match common patterns.

---

## Acceptance Criteria

1. OpenAI API integration implemented using OpenAI SDK
2. AI fallback triggered when rules-based parser returns null
3. Feature flag `USE_AI_FALLBACK` implemented (default: true)
4. AI prompt structured for JSON response format
5. Parse AI response to extract ParsedSIG data
6. Handle AI parsing errors gracefully
7. Add error handling and retry logic (max 1 retry, exponential backoff)
8. Handle timeouts (5 seconds per request)
9. All API calls use proper error handling and logging (PHI redacted)
10. AI fallback only used when rules-based parser fails

---

## Tasks / Subtasks

- [x] Integrate OpenAI SDK (AC: 1)
  - [x] Install OpenAI SDK package
  - [x] Create OpenAI client with API key from Firebase Secret Manager
  - [x] Configure client for GPT-4o-mini model
  - [x] Set up proper error handling
- [x] Implement AI fallback logic (AC: 2, 10)
  - [x] Update `functions/src/services/sig-parser.ts` with AI fallback
  - [x] Implement `parseWithAI(sig: string): Promise<ParsedSIG | null>` method
  - [x] Integrate AI fallback into main `parseSIG()` function
  - [x] Trigger AI fallback only when rules-based parser returns null
- [x] Implement feature flag (AC: 3)
  - [x] Add `USE_AI_FALLBACK` environment variable/feature flag
  - [x] Default to `true` for MVP
  - [x] Check flag before calling AI fallback
  - [x] Return null if flag is false and rules fail
- [x] Structure AI prompt for JSON response (AC: 4, 5)
  - [x] Create prompt template for SIG parsing
  - [x] Request JSON response with ParsedSIG structure
  - [x] Include examples in prompt for better accuracy
  - [x] Parse AI JSON response to ParsedSIG object
  - [x] Validate parsed response structure
- [x] Add error handling (AC: 6, 7, 8)
  - [x] Handle AI API errors gracefully
  - [x] Implement retry logic (max 1 retry, exponential backoff)
  - [x] Handle timeouts (5 seconds per request)
  - [x] Handle invalid JSON responses
  - [x] Return null on AI parsing failure (not an error)
- [x] Add logging and PHI redaction (AC: 9)
  - [x] Use structured logger from `functions/src/utils/logger.ts`
  - [x] Redact SIG text from logs (replace with `[REDACTED]`)
  - [x] Log AI fallback usage (success/failure rates)
  - [x] Log AI API errors (without PHI)
- [x] Add unit tests
  - [x] Test AI fallback when rules fail
  - [x] Test feature flag (enabled/disabled)
  - [x] Test AI prompt structure and JSON parsing
  - [x] Test error handling and retry logic
  - [x] Test timeout handling
  - [x] Test invalid JSON response handling
  - [x] Mock OpenAI API calls

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack** (from `docs/architecture.md` §3):
- **AI Integration**: OpenAI SDK (latest)
- **Model**: GPT-4o-mini
- **Secrets Management**: Firebase Secret Manager
- **Language**: TypeScript (latest stable)
- **Runtime**: Node.js 20
- **Logging**: Cloud Logging (native Firebase) - structured JSON logs

**OpenAI API Details** (from `docs/architecture.md` §6.3):
- **Base URL**: `https://api.openai.com/v1/`
- **Authentication**: API key via Firebase Secret Manager (`OPENAI_API_KEY`)
- **Rate Limits**: OpenAI tier limits (sufficient for MVP fallback usage)
- **Key Endpoints**:
  - `POST /chat/completions` - GPT-4o-mini for SIG parsing
- **Integration Notes**:
  - Feature flag `USE_AI_FALLBACK` (default: true for MVP)
  - Only called when rules-based parser fails
  - Expected fallback rate: ~10% of requests
  - Cost: ~$0.00001 per request average
  - Retry on 5xx errors and timeouts (max 1 retry, exponential backoff)
  - Timeout: 5 seconds per request

**SIG Parser Details** (from `docs/architecture.md` §5.5):
- **Responsibility**: Parse prescription SIG text into structured per-day consumption data
- **Key Interfaces**:
  - `parseWithRules(sig: string): ParsedSIG | null` - Rules-based parsing (Story 2.4)
  - `parseWithAI(sig: string): Promise<ParsedSIG | null>` - AI fallback parsing (this story)
  - `parseSIG(sig: string): Promise<ParsedSIG | null>` - Main parsing function (orchestrates both)
- **Technology Stack**: Regex patterns (Story 2.4), OpenAI SDK (this story)

**Hybrid SIG Parsing Pattern** (from `docs/architecture.md` §2.4):
- **Pattern**: Rules-based primary (fast) with AI fallback (accurate)
- **Rationale**: Balances speed (rules) with accuracy (AI) for SIG parsing
- **Implementation**: Try rules first, fall back to AI if rules fail

**Project Structure** (from `docs/architecture.md` §10):
```
functions/src/
├── services/
│   ├── rxnorm-client.ts    # RxNorm client (Story 2.1)
│   ├── fda-client.ts        # FDA client (Story 2.2)
│   └── sig-parser.ts        # SIG parser (update this)
├── utils/
│   ├── cache.ts             # LRU cache wrapper
│   ├── logger.ts            # Structured logging
│   └── errors.ts            # Error handling
└── types/
    └── index.ts             # TypeScript types (ParsedSIG from Story 2.4)
```

**Secrets Management** (from `docs/architecture.md` §13.3):
- **Development**: `.env` file (not committed) or Firebase emulator config
- **Production**: Firebase Secret Manager
- **Code Requirements**:
  - NEVER hardcode secrets
  - Access via `defineSecret()` from `firebase-functions/params`
  - No secrets in logs or error messages
- **Required Secrets**: `OPENAI_API_KEY` - OpenAI API key for SIG parsing fallback

**Error Handling** (from `docs/architecture.md` §12):
- **Retry Policy**: Max 1 retry, exponential backoff (1000ms, 2000ms max)
- **Timeout Configuration**: 5 seconds per upstream request
- **Error Translation**: Map external API errors to `ErrorResponse` format
- **Parse Failures**: Return null (not an error) - indicates unparseable SIG

**Logging Standards** (from `docs/architecture.md` §12.2):
- **Format**: Structured JSON logs
- **PHI Redaction**: Always redact `sig` from logs (replace with `[REDACTED]`)
- **Logging**: Log AI fallback usage rates (without PHI)

### Source Tree Details

This story updates `functions/src/services/sig-parser.ts` to add AI fallback functionality. The main `parseSIG()` function should orchestrate: try rules first, then AI if rules fail.

### Key Implementation Notes

1. **AI Prompt Structure**: Create a clear, structured prompt that:
   - Explains the task (parse prescription SIG)
   - Requests JSON response format
   - Includes examples of expected input/output
   - Specifies ParsedSIG structure
   - Emphasizes accuracy and consistency

2. **JSON Response Parsing**: 
   - Parse AI response as JSON
   - Validate structure matches ParsedSIG interface
   - Handle malformed JSON gracefully (return null)

3. **Feature Flag**: Implement `USE_AI_FALLBACK` as an environment variable or config:
   - Default: `true` for MVP
   - Can be disabled for testing or cost control
   - Check flag before calling AI fallback

4. **Error Handling**: 
   - AI API errors should not crash the system
   - Return null on AI failure (triggers parse_error response)
   - Log errors for monitoring (without PHI)

5. **Cost Management**: 
   - Only call AI when rules fail (~10% of requests expected)
   - Use GPT-4o-mini (cheaper than GPT-4)
   - Monitor AI usage rates

6. **Secrets Access**: Use Firebase Secret Manager:
   ```typescript
   import { defineSecret } from 'firebase-functions/params';
   const openaiApiKey = defineSecret('OPENAI_API_KEY');
   ```

7. **Main parseSIG() Function**: Should orchestrate both parsers:
   ```typescript
   async function parseSIG(sig: string): Promise<ParsedSIG | null> {
     // Try rules first
     const rulesResult = parseWithRules(sig);
     if (rulesResult) return rulesResult;
     
     // Fall back to AI if rules fail and flag is enabled
     if (USE_AI_FALLBACK) {
       return await parseWithAI(sig);
     }
     
     return null;
   }
   ```

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- **Framework**: TBD (Jest or Vitest recommended) - to be determined in Epic 1
- **File Convention**: `*.test.ts` co-located with source
- **Location**: `functions/src/services/sig-parser.test.ts` (update existing tests)
- **Mocking**: Mock OpenAI API calls
- **Coverage Requirement**: 80%+ for core algorithms

**Test Cases Required**:
1. AI fallback triggered when rules fail
2. Feature flag enabled - AI called when rules fail
3. Feature flag disabled - null returned when rules fail
4. AI successfully parses complex SIG
5. AI returns valid JSON response
6. AI returns invalid JSON - handled gracefully
7. AI API error - handled gracefully (returns null)
8. Retry on 5xx error (successful retry)
9. Retry on 5xx error (retry fails)
10. Timeout handling
11. PHI redaction in logs
12. AI usage rate logging

### Important Notes

- This story builds on Story 2.4 - ensure rules-based parser is complete first
- AI fallback should only be used when rules fail (~10% expected)
- Feature flag allows disabling AI for testing or cost control
- Never log the actual SIG text - always redact
- Cost is minimal (~$0.00001 per request) but monitor usage
- AI parsing failures should return null (not crash) - triggers parse_error response

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Manager |

---

## Dev Agent Record

_To be populated by dev agent during implementation_

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_


