# Story 2.7: Multi-Pack Selection Algorithm

## Status

**Current Status**: Completed

---

## Story

**As a** system,  
**I want** to select optimal package combinations based on calculated quantity,  
**so that** I can recommend the best NDC packages that minimize overfill while meeting quantity requirements.

---

## Acceptance Criteria

1. Multi-pack selection algorithm implemented using greedy approach
2. Pre-filter NDCs by active status (FDA as source of truth)
3. Try 1-pack, 2-pack, 3-pack combinations per NDC
4. Score and rank packages (exact match > minimal overfill > fewer packs)
5. Support single-NDC multi-pack (e.g., 30×2 = 60 tablets)
6. Enforce MAX_PACKS (3) and OVERFILL_MAX (10%) constraints
7. Return chosen package and alternates list
8. Handle cases where no suitable package found
9. Apply preferred NDCs ranking bias if provided
10. Calculate overfill percentage for each option

---

## Tasks / Subtasks

- [x] Implement package selection algorithm (AC: 1, 3, 4)
  - [x] Create `functions/src/services/package-selector.ts`
  - [x] Implement `selectPackages(ndcs: NDCPackageData[], totalQty: number, config: SelectionConfig): PackageSelection` method
  - [x] Try 1-pack, 2-pack, 3-pack combinations per NDC
  - [x] Calculate total quantity for each combination
  - [x] Score each combination based on ranking rules
- [x] Implement NDC pre-filtering (AC: 2)
  - [x] Filter NDCs by active status (FDA as source of truth)
  - [x] Exclude inactive NDCs from selection
  - [x] Flag inactive NDCs in response flags
- [x] Implement scoring and ranking (AC: 4, 10)
  - [x] Score exact matches highest (overfill = 0)
  - [x] Score minimal overfill next (overfill > 0 and ≤ OVERFILL_MAX)
  - [x] Score fewer packs higher (prefer 1-pack over 2-pack, etc.)
  - [x] Calculate overfill percentage for each option
  - [x] Rank all options by score
- [x] Implement constraints (AC: 6)
  - [x] Enforce MAX_PACKS = 3 (reject combinations with > 3 packs)
  - [x] Enforce OVERFILL_MAX = 10% (reject combinations with > 10% overfill)
  - [x] Make constraints configurable via SelectionConfig
- [x] Implement preferred NDCs bias (AC: 9)
  - [x] Apply ranking bias to preferred NDCs if provided
  - [x] Boost score for preferred NDCs (within same score tier)
  - [x] Handle invalid preferred NDCs gracefully
- [x] Implement single-NDC multi-pack support (AC: 5)
  - [x] Support same NDC in multiple packs (e.g., 30×2)
  - [x] Calculate total quantity correctly for multi-pack
  - [x] Score multi-pack combinations appropriately
- [x] Implement response structure (AC: 7, 8)
  - [x] Return chosen package (best match) or null if none found
  - [x] Return alternates list (next best options, max 10)
  - [x] Include package details (NDC, size, active, overfill, packs)
  - [x] Handle no suitable package found (return empty alternates)
- [x] Add unit tests
  - [x] Test exact match selection
  - [x] Test minimal overfill selection
  - [x] Test multi-pack combinations (1-pack, 2-pack, 3-pack)
  - [x] Test single-NDC multi-pack (e.g., 30×2)
  - [x] Test NDC pre-filtering (active vs inactive)
  - [x] Test scoring and ranking logic
  - [x] Test MAX_PACKS constraint
  - [x] Test OVERFILL_MAX constraint
  - [x] Test preferred NDCs bias
  - [x] Test no suitable package found
  - [x] Test edge cases (zero quantity, very large quantity)

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack** (from `docs/architecture.md` §3):
- **Language**: TypeScript (latest stable)
- **Runtime**: Node.js 20
- **Algorithm**: Greedy algorithm for package selection

**Package Selection Engine** (from `docs/architecture.md` §5.6):
- **Responsibility**: Select optimal package combination based on quantity and ranking rules
- **Key Interfaces**:
  - `selectPackages(ndcs: NDCPackageData[], totalQty: number, config: SelectionConfig): PackageSelection`
- **Technology Stack**: TypeScript algorithms

**Multi-Pack Selection Algorithm** (from `docs/architecture.md` §7.1 and PRD):
- **Algorithm**: Greedy approach
- **Pre-filter**: NDCs by active status (FDA as source of truth)
- **Try**: 1-pack, 2-pack, 3-pack combinations per NDC
- **Score**: Exact match > minimal overfill > fewer packs
- **Support**: Single-NDC multi-pack (e.g., 30×2)
- **Constraints**: MAX_PACKS = 3, OVERFILL_MAX = 10%

**Data Models** (from `docs/architecture.md` §4.2):
- **PackageSelection Structure**:
  ```typescript
  {
    chosen?: {
      ndc: string;
      pkg_size: number;
      active: boolean;
      overfill: number;      // Percentage overfill
      packs: number;        // Number of packs
    };
    alternates: Array<{
      ndc: string;
      pkg_size: number;
      active: boolean;
      overfill: number;
      packs: number;
    }>;
  }
  ```

**Project Structure** (from `docs/architecture.md` §10):
```
functions/src/
├── services/
│   ├── rxnorm-client.ts        # RxNorm client (Story 2.1)
│   ├── fda-client.ts           # FDA client (Story 2.2)
│   ├── sig-parser.ts           # SIG parser (Stories 2.4, 2.5)
│   ├── quantity-calculator.ts  # Quantity calculator (Story 2.6)
│   └── package-selector.ts    # Package selector (this story)
├── utils/
│   ├── cache.ts                # LRU cache wrapper
│   ├── logger.ts               # Structured logging
│   └── errors.ts               # Error handling
└── types/
    └── index.ts                # TypeScript types (add PackageSelection, SelectionConfig)
```

**Core Workflow** (from `docs/architecture.md` §7.1):
- Calculate total_qty (Story 2.6)
- Select packages based on total_qty (this story)
- Return chosen package and alternates

**FDA as Source of Truth** (from `docs/architecture.md` §6.2):
- FDA is authoritative for NDC activity status
- Pre-filter NDCs by active status before selection
- Flag inactive NDCs in response flags

**Ranking Rules** (from PRD):
1. Exact match (overfill = 0) - highest priority
2. Minimal overfill (overfill > 0 and ≤ 10%) - next priority
3. Fewer packs (prefer 1-pack over 2-pack, 2-pack over 3-pack) - tiebreaker

**Constraints** (from PRD):
- MAX_PACKS = 3 (maximum number of packs in a combination)
- OVERFILL_MAX = 10% (maximum acceptable overfill percentage)

**Preferred NDCs** (from `docs/architecture.md` §4.1):
- Optional `preferred_ndcs` array in request
- Apply ranking bias to preferred NDCs (within same score tier)

### Source Tree Details

The package selector should be implemented in `functions/src/services/package-selector.ts`. It takes NDCPackageData array (from FDA client), totalQty (from quantity calculator), and selection config, then returns the optimal package selection.

### Key Implementation Notes

1. **SelectionConfig Type**: Define a TypeScript interface:
   ```typescript
   export interface SelectionConfig {
     maxPacks?: number;           // Default: 3
     maxOverfill?: number;         // Default: 0.10 (10%)
     preferredNdcs?: string[];    // Optional preferred NDCs
   }
   ```

2. **PackageSelection Type**: Define a TypeScript interface matching ComputeResponse schema.

3. **Algorithm Steps**:
   - Pre-filter NDCs by active status (FDA as source of truth)
   - For each active NDC, try 1-pack, 2-pack, 3-pack combinations
   - Calculate total quantity for each combination: `total = pkg_size × packs`
   - Calculate overfill: `overfill = (total - totalQty) / totalQty`
   - Score each combination:
     - Exact match (overfill = 0): score = 1000
     - Minimal overfill (0 < overfill ≤ 10%): score = 1000 - (overfill × 100)
     - Over overfill limit: score = 0 (reject)
   - Apply pack count penalty: score -= (packs - 1) × 10
   - Apply preferred NDC boost: score += 50 (if in preferred list)
   - Rank by score (highest first)
   - Select best match as chosen, next 10 as alternates

4. **Single-NDC Multi-Pack**: Support same NDC in multiple packs:
   - Example: NDC with pkg_size=30, try 30×1, 30×2, 30×3
   - Calculate total: 30×2 = 60 tablets

5. **Constraints**:
   - MAX_PACKS = 3: Reject combinations with > 3 packs
   - OVERFILL_MAX = 10%: Reject combinations with > 10% overfill

6. **Preferred NDCs**: Apply ranking bias:
   - If NDC is in preferred list, boost score by 50 points
   - Only applies within same score tier (doesn't override exact match)

7. **No Suitable Package**: If no package meets constraints:
   - Return null for chosen
   - Return empty alternates list
   - Flag in response (may need error or warning)

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- **Framework**: TBD (Jest or Vitest recommended) - to be determined in Epic 1
- **File Convention**: `*.test.ts` co-located with source
- **Location**: `functions/src/services/package-selector.test.ts`
- **Coverage Requirement**: 80%+ for core algorithms

**Test Cases Required**:
1. Exact match selection (overfill = 0)
2. Minimal overfill selection (overfill ≤ 10%)
3. Multi-pack combinations (1-pack, 2-pack, 3-pack)
4. Single-NDC multi-pack (e.g., 30×2)
5. NDC pre-filtering (active vs inactive)
6. Scoring and ranking logic (exact > overfill > fewer packs)
7. MAX_PACKS constraint (reject > 3 packs)
8. OVERFILL_MAX constraint (reject > 10% overfill)
9. Preferred NDCs bias (boost score)
10. No suitable package found (return null)
11. Edge cases (zero quantity, very large quantity, no active NDCs)

### Important Notes

- This is the core algorithm that determines package recommendations
- FDA is always the source of truth for NDC activity status
- Greedy algorithm is sufficient for MVP - can optimize later if needed
- Scoring system should prioritize exact matches and minimal overfill
- Constraints (MAX_PACKS, OVERFILL_MAX) are configurable for flexibility
- Preferred NDCs provide ranking bias but don't override quality rules

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Manager |

---

## Dev Agent Record

_To be populated by dev agent during implementation_

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_

