# Story 2.6: Quantity Calculation Engine

## Status

**Current Status**: Completed

---

## Story

**As a** system,  
**I want** to calculate the total quantity needed based on per-day consumption and days supply,  
**so that** I can determine the exact amount of medication required for package selection.

---

## Acceptance Criteria

1. Quantity calculation engine implemented
2. Calculate `total_qty = per_day × days_supply`
3. Handle unit normalization (tab, cap, mL, etc.)
4. Support basic unit types (tab, cap) for MVP
5. Return structured computed data (dose_unit, per_day, total_qty, days_supply)
6. Handle edge cases (zero values, negative values, etc.)
7. Validate inputs before calculation
8. Return appropriate errors for invalid inputs

---

## Tasks / Subtasks

- [x] Implement quantity calculation logic (AC: 1, 2)
  - [x] Create `functions/src/services/quantity-calculator.ts`
  - [x] Implement `calculateQuantity(parsedSIG: ParsedSIG, daysSupply: number): ComputedData` method
  - [x] Calculate `total_qty = per_day × days_supply`
  - [x] Return structured computed data
- [x] Implement unit normalization (AC: 3, 4)
  - [x] Normalize unit types (tab, cap, mL, etc.)
  - [x] Support basic unit types for MVP (tab, cap)
  - [x] Handle unit override from request if provided
  - [x] Validate unit types
- [x] Create computed data structure (AC: 5)
  - [x] Define ComputedData TypeScript interface
  - [x] Include dose_unit, per_day, total_qty, days_supply
  - [x] Ensure structure matches ComputeResponse schema
- [x] Add input validation (AC: 7, 8)
  - [x] Validate per_day > 0
  - [x] Validate days_supply > 0 and ≤ 365
  - [x] Validate unit type is supported
  - [x] Return appropriate errors for invalid inputs
- [x] Handle edge cases (AC: 6)
  - [x] Handle zero values (return error)
  - [x] Handle negative values (return error)
  - [x] Handle very large values (validate reasonable limits)
  - [x] Handle decimal values (round appropriately)
- [x] Add unit tests
  - [x] Test basic quantity calculation (per_day × days_supply)
  - [x] Test unit normalization
  - [x] Test edge cases (zero, negative, large values)
  - [x] Test input validation
  - [x] Test unit override handling
  - [x] Test decimal rounding

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack** (from `docs/architecture.md` §3):
- **Language**: TypeScript (latest stable)
- **Runtime**: Node.js 20
- **Validation**: Zod (for input validation - Story 2.8)

**Quantity Calculation** (from `docs/architecture.md` §7.1):
- **Calculation**: `total_qty = per_day × days_supply`
- **Input**: ParsedSIG (from Story 2.4/2.5) and days_supply (from request)
- **Output**: ComputedData structure for package selection (Story 2.7)

**Data Models** (from `docs/architecture.md` §4.2):
- **ComputedData Structure**:
  ```typescript
  {
    dose_unit: string;      // e.g., "tab", "cap", "mL"
    per_day: number;         // Quantity per day
    total_qty: number;       // Total quantity needed
    days_supply: number;     // Days of supply
  }
  ```

**Project Structure** (from `docs/architecture.md` §10):
```
functions/src/
├── services/
│   ├── rxnorm-client.ts        # RxNorm client (Story 2.1)
│   ├── fda-client.ts           # FDA client (Story 2.2)
│   ├── sig-parser.ts           # SIG parser (Stories 2.4, 2.5)
│   └── quantity-calculator.ts  # Quantity calculator (this story)
├── utils/
│   ├── cache.ts                # LRU cache wrapper
│   ├── logger.ts               # Structured logging
│   └── errors.ts               # Error handling
└── types/
    └── index.ts                # TypeScript types (add ComputedData)
```

**Core Workflow** (from `docs/architecture.md` §7.1):
- Parse SIG to get per_day (Stories 2.4, 2.5)
- Calculate total_qty = per_day × days_supply (this story)
- Select packages based on total_qty (Story 2.7)

**Error Handling** (from `docs/architecture.md` §12):
- **Validation Errors**: Return `validation_error` with field errors
- **Business Logic Errors**: Return appropriate error codes
- **Error Translation**: Map to `ErrorResponse` format

**Unit Types** (from `docs/architecture.md` §4.1):
- **Supported Units**: `'tab'|'cap'|'mL'|'actuation'|'unit'`
- **MVP Focus**: tab, cap (basic unit types)
- **Unit Override**: Optional `quantity_unit_override` in request

### Source Tree Details

The quantity calculator should be implemented in `functions/src/services/quantity-calculator.ts`. It takes ParsedSIG from the SIG parser and days_supply from the request, then calculates the total quantity.

### Key Implementation Notes

1. **ComputedData Type**: Define a TypeScript interface:
   ```typescript
   export interface ComputedData {
     dose_unit: string;      // Normalized unit (tab, cap, mL, etc.)
     per_day: number;        // Quantity per day
     total_qty: number;      // Total quantity needed (per_day × days_supply)
     days_supply: number;     // Days of supply
   }
   ```

2. **Calculation Logic**: 
   - Simple multiplication: `total_qty = per_day × days_supply`
   - Round to appropriate precision (integers for tab/cap, decimals for mL)
   - Validate result is positive and reasonable

3. **Unit Normalization**:
   - Normalize unit from ParsedSIG or use override from request
   - Support basic units for MVP: tab, cap
   - Validate unit is supported

4. **Input Validation**:
   - per_day must be > 0
   - days_supply must be > 0 and ≤ 365 (validated in Story 2.8, but check here too)
   - dose_unit must be a supported unit type

5. **Edge Cases**:
   - Zero values: Return validation error
   - Negative values: Return validation error
   - Very large values: Validate reasonable limits (e.g., total_qty ≤ 10,000)
   - Decimal values: Round appropriately (integers for tab/cap, 2 decimals for mL)

6. **Integration**: This service is called after SIG parsing and before package selection:
   - Input: ParsedSIG (from sig-parser.ts)
   - Output: ComputedData (for package-selector.ts)

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- **Framework**: TBD (Jest or Vitest recommended) - to be determined in Epic 1
- **File Convention**: `*.test.ts` co-located with source
- **Location**: `functions/src/services/quantity-calculator.test.ts`
- **Coverage Requirement**: 80%+ for core algorithms

**Test Cases Required**:
1. Basic quantity calculation (per_day × days_supply)
2. Unit normalization (tab, cap)
3. Unit override from request
4. Zero per_day (should return error)
5. Zero days_supply (should return error)
6. Negative values (should return error)
7. Very large values (should validate limits)
8. Decimal rounding (integers for tab/cap, decimals for mL)
9. Invalid unit types (should return error)
10. Edge cases (boundary values)

### Important Notes

- This is a simple calculation but critical for package selection
- Input validation is important - catch invalid inputs early
- Unit normalization ensures consistency across the system
- MVP focuses on basic units (tab, cap) - can expand later
- This service is pure calculation - no external dependencies

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Manager |

---

## Dev Agent Record

_To be populated by dev agent during implementation_

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

- Implemented quantity calculation engine with formula: total_qty = per_day × days_supply
- Implemented unit normalization (tablet→tab, capsule→cap, etc.)
- Created ComputedData TypeScript interface
- Implemented comprehensive input validation
- Handles edge cases (zero, negative, large values)
- Implements decimal rounding (integers for tab/cap, 2 decimals for mL)
- All code compiles successfully
- Unit tests complete (21 tests passing)

### File List

- `functions/src/services/quantity-calculator.ts` - Quantity calculation service
- `functions/src/services/quantity-calculator.test.ts` - Quantity calculator unit tests (21 tests)

---

## QA Results

_To be populated by QA agent_

