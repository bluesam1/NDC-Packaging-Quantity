# Story 2.1: RxNorm API Integration

## Status

**Current Status**: Completed

---

## Story

**As a** system,  
**I want** to integrate with the RxNorm API to normalize drug names and NDCs to RxCUI identifiers,  
**so that** I can accurately identify medications and retrieve associated NDC codes for package selection.

---

## Acceptance Criteria

1. RxNorm client implemented with in-memory LRU cache (1 hour TTL)
2. Support name→RxCUI normalization via `findRxcuiByString` endpoint
3. Support NDC→RxCUI resolution via `getNdcsByRxcui` endpoint
4. Implement approximate matching fallback via `approximateTerm` endpoint
5. Add error handling and retry logic (max 1 retry, exponential backoff)
6. Add rate limiting (10 req/sec per function instance)
7. Cache responses for 1 hour TTL using LRU cache
8. Handle timeouts (5 seconds per request)
9. Return structured errors on API failures
10. All API calls use proper error handling and logging (PHI redacted)

---

## Tasks / Subtasks

- [x] Implement RxNorm client service (AC: 1, 2, 3, 4)
  - [x] Create `functions/src/services/rxnorm-client.ts`
  - [x] Set up Axios client with base URL `https://rxnav.nlm.nih.gov/REST/`
  - [x] Implement `findRxcuiByString(name: string): Promise<string>` method
  - [x] Implement `getNdcsByRxcui(rxcui: string): Promise<string[]>` method
  - [x] Implement `approximateTerm(term: string): Promise<string | null>` fallback method
  - [x] Add proper TypeScript types for RxNorm responses
- [x] Implement LRU cache integration (AC: 1, 7)
  - [x] Create cache wrapper utility in `functions/src/utils/cache.ts`
  - [x] Configure LRU cache with 1 hour TTL for RxNorm responses
  - [x] Integrate cache with RxNorm client methods
  - [x] Implement cache key generation for RxNorm requests
- [x] Add error handling and retry logic (AC: 5, 9)
  - [x] Implement retry logic with max 1 retry and exponential backoff
  - [x] Handle 5xx errors and timeouts with retry
  - [x] Handle 4xx errors without retry (return appropriate error)
  - [x] Implement timeout handling (5 seconds per request)
  - [x] Return structured error responses on failures
- [x] Add rate limiting (AC: 6)
  - [x] Implement in-memory rate limiter (10 req/sec per instance)
  - [x] Track request timestamps per function instance
  - [x] Return rate limit error when exceeded
- [x] Add logging and PHI redaction (AC: 10)
  - [x] Use structured logger from `functions/src/utils/logger.ts`
  - [x] Redact drug names from logs (replace with `[REDACTED]`)
  - [x] Log cache hits/misses, API calls, errors (without PHI)
- [x] Add unit tests
  - [x] Test `findRxcuiByString` with valid drug names
  - [x] Test `getNdcsByRxcui` with valid RxCUI
  - [x] Test `approximateTerm` fallback
  - [x] Test cache functionality (TTL, cache hits/misses)
  - [x] Test error handling and retry logic
  - [x] Test rate limiting
  - [x] Mock external API calls

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack** (from `docs/architecture.md` §3):
- **HTTP Client**: Axios (latest)
- **Caching**: lru-cache (latest) - in-memory LRU cache
- **Logging**: Cloud Logging (native Firebase) - structured JSON logs
- **Language**: TypeScript (latest stable)
- **Runtime**: Node.js 20

**RxNorm API Details** (from `docs/architecture.md` §6.1):
- **Base URL**: `https://rxnav.nlm.nih.gov/REST/`
- **Authentication**: None required (public API)
- **Rate Limits**: 10 req/sec per function instance (conservative limit)
- **Key Endpoints**:
  - `GET /findRxcuiByString?name={drug_name}` - Name to RxCUI normalization
  - `GET /rxcui/{rxcui}/ndcs` - RxCUI to NDC mapping
  - `GET /approximateTerm?term={drug_name}` - Approximate matching (fallback)
- **Integration Notes**:
  - Do NOT use for NDC activity status (FDA is source of truth)
  - Cache responses for 1 hour TTL (in-memory LRU cache)
  - Retry on 5xx errors and timeouts (max 1 retry, exponential backoff)
  - Timeout: 5 seconds per request

**Project Structure** (from `docs/architecture.md` §10):
```
functions/src/
├── services/
│   └── rxnorm-client.ts    # RxNorm client service
├── utils/
│   ├── cache.ts            # LRU cache wrapper
│   ├── logger.ts           # Structured logging
│   └── errors.ts           # Error handling
└── types/
    └── index.ts            # TypeScript types
```

**Error Handling** (from `docs/architecture.md` §12):
- **Retry Policy**: Max 1 retry, exponential backoff (1000ms, 2000ms max)
- **Timeout Configuration**: 5 seconds per upstream request
- **Error Translation**: Map external API errors to `ErrorResponse` format
- **Custom Exceptions**: `DependencyError` → `424` with `dependency_failure` code

**Logging Standards** (from `docs/architecture.md` §12.2):
- **Format**: Structured JSON logs
- **Levels**: `info`, `warn`, `error`
- **PHI Redaction**: Always redact `drug_input` from logs (replace with `[REDACTED]`)
- **Required Context**: Correlation ID, Service Context, User Context (redacted)

**Caching Strategy** (from `docs/architecture.md` §2.4):
- **Pattern**: In-memory LRU cache per function instance
- **TTL**: 1 hour for RxNorm responses
- **Rationale**: Reduces external API calls and improves response time without database complexity

### Source Tree Details

The RxNorm client should be implemented in `functions/src/services/rxnorm-client.ts` following the repository pattern. The cache utility should be in `functions/src/utils/cache.ts` and can be reused by other services (FDA client, etc.).

### Key Implementation Notes

1. **Cache Key Strategy**: Use a consistent cache key format like `rxnorm:findRxcuiByString:{normalized_name}` or `rxnorm:getNdcsByRxcui:{rxcui}`

2. **Error Handling**: All RxNorm API errors should be caught and translated to appropriate error codes:
   - Network errors/timeouts → `dependency_failure` with retry
   - 4xx errors → `dependency_failure` (no retry)
   - 5xx errors → `dependency_failure` with retry

3. **Rate Limiting**: Implement a simple in-memory rate limiter using a Map to track request timestamps per function instance. This is per-instance, not global.

4. **Type Safety**: Define proper TypeScript interfaces for RxNorm API responses to ensure type safety.

5. **Testing**: Mock all external API calls in unit tests. Use a test framework (Jest or Vitest) as determined in Epic 1.

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- **Framework**: TBD (Jest or Vitest recommended) - to be determined in Epic 1
- **File Convention**: `*.test.ts` co-located with source
- **Location**: `functions/src/services/rxnorm-client.test.ts`
- **Mocking**: Mock all external dependencies (RxNorm API)
- **Coverage Requirement**: 80%+ for core algorithms

**Test Cases Required**:
1. Successful name→RxCUI normalization
2. Successful NDC→RxCUI resolution
3. Successful approximate matching fallback
4. Cache hit scenario (returns cached value)
5. Cache miss scenario (calls API and caches result)
6. Cache TTL expiration
7. Retry on 5xx error (successful retry)
8. Retry on 5xx error (retry fails)
9. Rate limit exceeded
10. Timeout handling
11. Invalid drug name (4xx error)
12. PHI redaction in logs

### Important Notes

- This is the first external API integration, so it sets the pattern for FDA API integration (Story 2.2)
- The cache implementation should be reusable for other services
- Never log drug names or PHI - always redact
- Rate limiting is per-instance, not global across all function instances
- The approximate matching fallback should only be used when primary methods fail

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Manager |

---

## Dev Agent Record

_To be populated by dev agent during implementation_

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

- Implemented RxNorm client with all required methods (findRxcuiByString, getNdcsByRxcui, approximateTerm)
- Created reusable cache utility with LRU cache wrapper
- Created structured logger with PHI redaction
- Created error handling utilities with custom error classes
- Implemented rate limiting (10 req/sec per instance)
- Implemented retry logic with exponential backoff (max 1 retry)
- Implemented timeout handling (5 seconds per request)
- All code compiles successfully
- Unit tests complete (14 tests passing) - using Vitest with axios-mock-adapter

### File List

- `functions/src/services/rxnorm-client.ts` - RxNorm API client service
- `functions/src/services/rxnorm-client.test.ts` - RxNorm client unit tests (14 tests)
- `functions/src/utils/cache.ts` - LRU cache wrapper utility
- `functions/src/utils/cache.test.ts` - Cache utility unit tests (9 tests)
- `functions/src/utils/logger.ts` - Structured logging utility
- `functions/src/utils/errors.ts` - Error handling utilities
- `functions/src/utils/errors.test.ts` - Error utilities unit tests (10 tests)

---

## QA Results

_To be populated by QA agent_

