# Story 2.2: FDA NDC Directory API Integration

## Status

**Current Status**: Completed

---

## Story

**As a** system,  
**I want** to integrate with the FDA NDC Directory API to retrieve authoritative package data including status, package sizes, and dosage forms,  
**so that** I can accurately select active NDC packages and determine optimal package combinations.

---

## Acceptance Criteria

1. FDA API client implemented with in-memory LRU cache (24 hours TTL)
2. Support NDC lookup via `search=product_ndc:{ndc}` endpoint
3. Support brand name search via `search=brand_name:{name}` endpoint
4. Retrieve package metadata (package size, active status, dosage form)
5. Add error handling and retry logic (max 1 retry, exponential backoff)
6. Add rate limiting (3 req/sec per function instance)
7. Cache responses for 24 hours TTL using LRU cache
8. Handle timeouts (5 seconds per request)
9. Return structured errors on API failures
10. All API calls use proper error handling and logging (PHI redacted)
11. FDA is treated as source of truth for NDC activity status

---

## Tasks / Subtasks

- [x] Implement FDA API client service (AC: 1, 2, 3, 4)
  - [x] Create `functions/src/services/fda-client.ts`
  - [x] Set up Axios client with base URL `https://api.fda.gov/drug/ndc.json`
  - [x] Implement `lookupByNDC(ndc: string): Promise<NDCPackageData>` method
  - [x] Implement `searchByBrandName(name: string): Promise<NDCPackageData[]>` method
  - [x] Parse FDA API response to extract package metadata
  - [x] Add proper TypeScript types for FDA API responses and NDCPackageData
- [x] Implement LRU cache integration (AC: 1, 7)
  - [x] Reuse cache wrapper utility from Story 2.1 (`functions/src/utils/cache.ts`)
  - [x] Configure LRU cache with 24 hours TTL for FDA responses
  - [x] Integrate cache with FDA client methods
  - [x] Implement cache key generation for FDA requests
- [x] Add error handling and retry logic (AC: 5, 9)
  - [x] Implement retry logic with max 1 retry and exponential backoff
  - [x] Handle 5xx errors and timeouts with retry
  - [x] Handle 4xx errors without retry (return appropriate error)
  - [x] Implement timeout handling (5 seconds per request)
  - [x] Return structured error responses on failures
- [x] Add rate limiting (AC: 6)
  - [x] Implement in-memory rate limiter (3 req/sec per instance)
  - [x] Track request timestamps per function instance
  - [x] Return rate limit error when exceeded
- [x] Add logging and PHI redaction (AC: 10)
  - [x] Use structured logger from `functions/src/utils/logger.ts`
  - [x] Redact drug names from logs (replace with `[REDACTED]`)
  - [x] Log cache hits/misses, API calls, errors (without PHI)
- [x] Add unit tests
  - [x] Test `lookupByNDC` with valid NDC codes
  - [x] Test `searchByBrandName` with valid brand names
  - [x] Test package metadata extraction (size, status, dosage form)
  - [x] Test cache functionality (TTL, cache hits/misses)
  - [x] Test error handling and retry logic
  - [x] Test rate limiting
  - [x] Mock external API calls

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack** (from `docs/architecture.md` §3):
- **HTTP Client**: Axios (latest)
- **Caching**: lru-cache (latest) - in-memory LRU cache (reuse from Story 2.1)
- **Logging**: Cloud Logging (native Firebase) - structured JSON logs
- **Language**: TypeScript (latest stable)
- **Runtime**: Node.js 20

**FDA NDC Directory API Details** (from `docs/architecture.md` §6.2):
- **Base URL**: `https://api.fda.gov/drug/ndc.json`
- **Authentication**: None required (public API)
- **Rate Limits**: 3 req/sec per instance (openFDA limit: 240/min)
- **Key Endpoints**:
  - `GET /?search=product_ndc:{ndc}` - Lookup by NDC
  - `GET /?search=brand_name:{name}` - Search by brand name
- **Integration Notes**:
  - Source of truth for NDC activity status and package metadata
  - If FDA and RxNorm disagree, trust FDA for status/packaging
  - Cache responses for 24 hours TTL (in-memory LRU cache)
  - Retry on 5xx errors and timeouts (max 1 retry, exponential backoff)
  - Timeout: 5 seconds per request

**Project Structure** (from `docs/architecture.md` §10):
```
functions/src/
├── services/
│   ├── rxnorm-client.ts    # RxNorm client (Story 2.1)
│   └── fda-client.ts       # FDA client service
├── utils/
│   ├── cache.ts            # LRU cache wrapper (reuse from Story 2.1)
│   ├── logger.ts           # Structured logging
│   └── errors.ts           # Error handling
└── types/
    └── index.ts            # TypeScript types (add NDCPackageData)
```

**Error Handling** (from `docs/architecture.md` §12):
- **Retry Policy**: Max 1 retry, exponential backoff (1000ms, 2000ms max)
- **Timeout Configuration**: 5 seconds per upstream request
- **Error Translation**: Map external API errors to `ErrorResponse` format
- **Custom Exceptions**: `DependencyError` → `424` with `dependency_failure` code

**Logging Standards** (from `docs/architecture.md` §12.2):
- **Format**: Structured JSON logs
- **Levels**: `info`, `warn`, `error`
- **PHI Redaction**: Always redact `drug_input` from logs (replace with `[REDACTED]`)
- **Required Context**: Correlation ID, Service Context, User Context (redacted)

**Caching Strategy** (from `docs/architecture.md` §2.4):
- **Pattern**: In-memory LRU cache per function instance
- **TTL**: 24 hours for FDA responses (longer than RxNorm due to less frequent updates)
- **Rationale**: Reduces external API calls and improves response time without database complexity

### Source Tree Details

The FDA client should be implemented in `functions/src/services/fda-client.ts` following the same pattern as the RxNorm client from Story 2.1. The cache utility from Story 2.1 should be reused.

### Key Implementation Notes

1. **Cache Key Strategy**: Use a consistent cache key format like `fda:lookupByNDC:{ndc}` or `fda:searchByBrandName:{normalized_name}`

2. **NDCPackageData Type**: Define a TypeScript interface for package data:
   ```typescript
   export interface NDCPackageData {
     ndc: string;
     pkg_size: number;
     active: boolean;
     dosage_form?: string;
     brand_name?: string;
     // ... other relevant fields from FDA API
   }
   ```

3. **FDA as Source of Truth**: When FDA and RxNorm data conflict, always trust FDA for:
   - NDC activity status
   - Package metadata (size, dosage form)
   - Marketing status

4. **Error Handling**: All FDA API errors should be caught and translated to appropriate error codes (same pattern as RxNorm client).

5. **Rate Limiting**: FDA has a lower rate limit (3 req/sec) than RxNorm (10 req/sec), so implement a separate rate limiter or use a shared rate limiter with different limits per service.

6. **Testing**: Mock all external API calls in unit tests. Use the same test framework as Story 2.1.

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- **Framework**: TBD (Jest or Vitest recommended) - to be determined in Epic 1
- **File Convention**: `*.test.ts` co-located with source
- **Location**: `functions/src/services/fda-client.test.ts`
- **Mocking**: Mock all external dependencies (FDA API)
- **Coverage Requirement**: 80%+ for core algorithms

**Test Cases Required**:
1. Successful NDC lookup
2. Successful brand name search
3. Package metadata extraction (size, status, dosage form)
4. Cache hit scenario (returns cached value)
5. Cache miss scenario (calls API and caches result)
6. Cache TTL expiration (24 hours)
7. Retry on 5xx error (successful retry)
8. Retry on 5xx error (retry fails)
9. Rate limit exceeded (3 req/sec)
10. Timeout handling
11. Invalid NDC (4xx error)
12. PHI redaction in logs
13. Active vs inactive NDC status handling

### Important Notes

- This follows the same pattern as RxNorm client (Story 2.1) - reuse cache utility and error handling patterns
- FDA is the authoritative source for NDC activity status - this is critical for package selection
- Cache TTL is 24 hours (longer than RxNorm's 1 hour) because FDA data changes less frequently
- Rate limit is lower (3 req/sec) than RxNorm, so be mindful of this in implementation
- The NDCPackageData type will be used by the package selection algorithm (Story 2.7)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Manager |

---

## Dev Agent Record

_To be populated by dev agent during implementation_

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

- Implemented FDA client with all required methods (lookupByNDC, searchByBrandName)
- Reused cache utility from Story 2.1 with 24-hour TTL
- Implemented NDC normalization (handles formats with/without hyphens)
- Implemented package metadata parsing from FDA API response
- Added NDCPackageData type to types/index.ts
- Implemented rate limiting (3 req/sec per instance)
- Implemented retry logic with exponential backoff (max 1 retry)
- Implemented timeout handling (5 seconds per request)
- All code compiles successfully
- Unit tests complete (12 tests passing) - using Vitest with axios-mock-adapter

### File List

- `functions/src/services/fda-client.ts` - FDA API client service
- `functions/src/services/fda-client.test.ts` - FDA client unit tests (12 tests)
- `functions/src/types/index.ts` - Added NDCPackageData type

---

## QA Results

_To be populated by QA agent_

