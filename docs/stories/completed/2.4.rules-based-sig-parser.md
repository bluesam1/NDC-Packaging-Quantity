# Story 2.4: Rules-Based SIG Parser

## Status

**Current Status**: Completed

---

## Story

**As a** system,  
**I want** to parse prescription SIGs using regex-based rules for common patterns,  
**so that** I can quickly and accurately extract per-day consumption data for quantity calculation without relying on AI for common cases.

---

## Acceptance Criteria

1. Rules-based SIG parser implemented using regex patterns
2. Support common tablet/capsule patterns (QD, BID, TID, QID)
3. Support basic liquid formats (mL, teaspoon, tablespoon)
4. Normalize synonyms (PO, by mouth, orally, etc.)
5. Return binary confidence (parsed/not-parsed)
6. Extract dose unit (tab, cap, mL, etc.)
7. Extract per-day quantity
8. Handle common variations and abbreviations
9. Return structured ParsedSIG object on success
10. Return null when parsing fails (triggers AI fallback)

---

## Tasks / Subtasks

- [x] Implement rules-based parser (AC: 1, 2, 3, 4)
  - [x] Create `functions/src/services/sig-parser.ts`
  - [x] Implement `parseWithRules(sig: string): ParsedSIG | null` method
  - [x] Create regex patterns for common SIG patterns
  - [x] Support QD (once daily), BID (twice daily), TID (three times daily), QID (four times daily)
  - [x] Support tablet/capsule patterns (e.g., "take 1 tablet by mouth twice daily")
  - [x] Support basic liquid formats (e.g., "take 5 mL by mouth once daily")
  - [x] Normalize synonyms (PO, by mouth, orally, etc.)
- [x] Implement dose unit extraction (AC: 6)
  - [x] Extract unit type (tab, cap, mL, teaspoon, tablespoon, etc.)
  - [x] Normalize unit variations (tablet/tab, capsule/cap, etc.)
  - [x] Handle unit override from request if provided
- [x] Implement per-day quantity extraction (AC: 7)
  - [x] Extract quantity per dose (e.g., "take 2 tablets" → 2)
  - [x] Extract frequency (e.g., "twice daily" → 2)
  - [x] Calculate per_day = quantity_per_dose × frequency
- [x] Handle common variations (AC: 8)
  - [x] Support common abbreviations (QD, BID, TID, QID, PRN, etc.)
  - [x] Support spelled-out frequencies (once daily, twice daily, etc.)
  - [x] Handle variations in wording (take, use, administer, etc.)
  - [x] Support numeric frequencies (1x daily, 2x daily, etc.)
- [x] Implement structured return type (AC: 9, 10)
  - [x] Define ParsedSIG TypeScript interface
  - [x] Return ParsedSIG object on successful parse
  - [x] Return null when parsing fails (triggers AI fallback in Story 2.5)
  - [x] Include confidence indicator (binary: parsed/not-parsed)
- [x] Add unit tests
  - [x] Test common tablet patterns (QD, BID, TID, QID)
  - [x] Test basic liquid formats
  - [x] Test synonym normalization
  - [x] Test dose unit extraction
  - [x] Test per-day quantity calculation
  - [x] Test common variations and abbreviations
  - [x] Test parsing failures (should return null)
  - [x] Test edge cases and unusual formats

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack** (from `docs/architecture.md` §3):
- **Language**: TypeScript (latest stable)
- **Runtime**: Node.js 20
- **Parsing**: Regex patterns (no external dependencies)

**SIG Parser Details** (from `docs/architecture.md` §5.5):
- **Responsibility**: Parse prescription SIG text into structured per-day consumption data
- **Key Interfaces**:
  - `parseWithRules(sig: string): ParsedSIG | null` - Rules-based parsing
  - `parseSIG(sig: string): Promise<ParsedSIG | null>` - Main parsing function (includes AI fallback - Story 2.5)
- **Technology Stack**: Regex patterns, OpenAI SDK (fallback only - Story 2.5)

**Hybrid SIG Parsing Pattern** (from `docs/architecture.md` §2.4):
- **Pattern**: Rules-based primary (fast) with AI fallback (accurate)
- **Rationale**: Balances speed (rules) with accuracy (AI) for SIG parsing
- **Implementation**: Try rules first, fall back to AI if rules fail

**Project Structure** (from `docs/architecture.md` §10):
```
functions/src/
├── services/
│   ├── rxnorm-client.ts    # RxNorm client (Story 2.1)
│   ├── fda-client.ts        # FDA client (Story 2.2)
│   └── sig-parser.ts        # SIG parser (this story)
├── utils/
│   ├── cache.ts             # LRU cache wrapper
│   ├── logger.ts            # Structured logging
│   └── errors.ts            # Error handling
└── types/
    └── index.ts             # TypeScript types (add ParsedSIG)
```

**Core Workflow** (from `docs/architecture.md` §7.1):
- Parse SIG using rules-based parser first
- If rules fail, fall back to AI parser (Story 2.5)
- Extract per_day quantity for quantity calculation (Story 2.6)

**Error Handling** (from `docs/architecture.md` §12):
- **Parse Failures**: Return null (not an error) - triggers AI fallback
- **Invalid Input**: Return null or throw ParseError depending on context
- **Error Translation**: Map to `ErrorResponse` format with `parse_error` code

**Logging Standards** (from `docs/architecture.md` §12.2):
- **Format**: Structured JSON logs
- **PHI Redaction**: Always redact `sig` from logs (replace with `[REDACTED]`)
- **Logging**: Log parse success/failure rates (without PHI)

### Source Tree Details

The SIG parser should be implemented in `functions/src/services/sig-parser.ts`. This story implements the rules-based parser only. Story 2.5 will add the AI fallback integration.

### Key Implementation Notes

1. **ParsedSIG Type**: Define a TypeScript interface:
   ```typescript
   export interface ParsedSIG {
     dose_unit: string;      // e.g., "tab", "cap", "mL"
     per_day: number;         // Total quantity per day
     confidence: 'parsed';    // Binary: 'parsed' or 'not-parsed'
   }
   ```

2. **Regex Patterns**: Create comprehensive regex patterns for common SIG formats:
   - Tablet/capsule patterns: "take X tablet(s) by mouth [frequency]"
   - Liquid patterns: "take X mL by mouth [frequency]"
   - Frequency patterns: QD, BID, TID, QID, once daily, twice daily, etc.
   - Synonym normalization: PO, by mouth, orally, etc.

3. **Binary Confidence**: Return `'parsed'` when rules succeed, `null` when rules fail (triggers AI fallback).

4. **Unit Normalization**: Normalize unit variations:
   - tablet/tab → "tab"
   - capsule/cap → "cap"
   - milliliter/mL → "mL"
   - teaspoon/tsp → "mL" (with conversion)
   - tablespoon/tbsp → "mL" (with conversion)

5. **Per-Day Calculation**: Calculate per_day = quantity_per_dose × frequency
   - Example: "take 2 tablets twice daily" → per_day = 2 × 2 = 4

6. **Common Patterns to Support**:
   - "Take 1 tablet by mouth once daily"
   - "Take 2 capsules PO BID"
   - "Take 5 mL by mouth three times daily"
   - "1 tab PO QD"
   - "Take 1 tablet orally twice daily"

7. **Failure Cases**: Return null when:
   - No matching pattern found
   - Ambiguous parsing (multiple interpretations)
   - Unsupported format

### Testing

**Testing Standards** (from `docs/architecture.md` §15):
- **Framework**: TBD (Jest or Vitest recommended) - to be determined in Epic 1
- **File Convention**: `*.test.ts` co-located with source
- **Location**: `functions/src/services/sig-parser.test.ts`
- **Coverage Requirement**: 80%+ for core algorithms

**Test Cases Required**:
1. Common tablet patterns (QD, BID, TID, QID)
2. Basic liquid formats (mL, teaspoon, tablespoon)
3. Synonym normalization (PO, by mouth, orally)
4. Dose unit extraction (tab, cap, mL)
5. Per-day quantity calculation (various frequencies)
6. Common variations and abbreviations
7. Numeric frequencies (1x daily, 2x daily)
8. Parsing failures (should return null)
9. Edge cases (unusual formats, ambiguous inputs)
10. Unit normalization (tablet/tab, capsule/cap)
11. PHI redaction in logs

### Important Notes

- This is the primary (fast) parser - AI fallback is added in Story 2.5
- Return null on failure (not an error) - this triggers AI fallback
- Focus on common patterns first - don't try to handle every possible format
- Binary confidence is sufficient - detailed confidence scoring not needed
- This parser should handle ~90% of common SIGs to minimize AI fallback usage
- Never log the actual SIG text - always redact

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024 | 1.0 | Initial story creation | Product Manager |

---

## Dev Agent Record

_To be populated by dev agent during implementation_

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

- Implemented rules-based SIG parser with comprehensive regex patterns
- Supports QD, BID, TID, QID abbreviations and spelled-out frequencies
- Supports tablet, capsule, and liquid formats
- Implements unit normalization (tablet→tab, capsule→cap, etc.)
- Implements per-day quantity calculation (quantity × frequency)
- Handles common variations and synonyms
- Returns null on parsing failure (triggers AI fallback in Story 2.5)
- All code compiles successfully
- Unit tests complete (34 tests passing)

### File List

- `functions/src/services/sig-parser.ts` - Rules-based SIG parser service
- `functions/src/services/sig-parser.test.ts` - SIG parser unit tests (34 tests)

---

## QA Results

_To be populated by QA agent_

